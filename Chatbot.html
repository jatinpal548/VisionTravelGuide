<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Travel Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Load the Inter font and configure Tailwind
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'ai-bubble': '#374151', // Gray-700
                        'user-bubble': '#4f46e5', // Indigo-600
                        'indigo-glow': '#818cf8', // Indigo-400
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* 1. Subtle Radial Gradient Background */
        body {
            background-color: #111827; /* Darkest Gray */
            background-image: radial-gradient(at 0% 0%, #1f2937, #111827 70%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #e5e7eb;
            font-family: 'Inter', sans-serif;
        }

        /* Custom Scrollbar for Dark Mode */
        .chat-container::-webkit-scrollbar, .prose-output::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-thumb, .prose-output::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        .chat-container::-webkit-scrollbar-track, .prose-output::-webkit-scrollbar-track {
            background-color: #1f2937; /* gray-800 */
        }
        
        /* Loading Animation */
        .loading-animation {
            border: 4px solid #4b5563; /* gray-600 */
            border-top: 4px solid #4f46e5; /* indigo-600 */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 2. Message Fade-In Animation */
        .message-fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 3. Image Upload Pulsing Border */
        .upload-pulse {
            animation: pulse-border 1.5s infinite alternate;
        }

        @keyframes pulse-border {
            from {
                border-color: #374151; /* gray-700 */
                box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.2);
            }
            to {
                border-color: #4f46e5; /* indigo-600 */
                box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.0);
            }
        }

        /* -------------------------------------------
        ENHANCED STYLES FOR MARKDOWN OUTPUT (PROSE)
        ------------------------------------------- 
        */
        .prose-output h1, .prose-output h2, .prose-output h3 {
            color: #a5b4fc; /* indigo-300 */
            border-bottom: none;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        .prose-output p, .prose-output ul, .prose-output ol, .prose-output li {
            color: #e5e7eb; /* gray-200 */
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }
        .prose-output a {
            color: #a5b4fc; /* indigo-300 for links */
            text-decoration: underline;
            transition: color 0.1s;
        }
        .prose-output a:hover {
            color: #c4b5fd; /* violet-300 */
        }
        .prose-output ul, .prose-output ol {
            padding-left: 1.5em;
        }
        .prose-output code {
            background-color: #374151; /* gray-700 for inline code */
            color: #f3f4f6;
            padding: 0.1em 0.3em;
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <header class="bg-gray-900/90 backdrop-blur-sm shadow-2xl shadow-gray-950/70 p-4 sticky top-0 z-20">
        <h1 class="text-3xl font-extrabold text-indigo-400 text-center tracking-wider">
            üåç Vision Travel Guide
        </h1>
        <p class="text-sm text-center text-gray-400 mt-1">
            Analyze an image, plan your itinerary, and chat about your next adventure!
        </p>
    </header>

    <main class="flex-grow container mx-auto p-4 lg:p-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Left Panel: Context & Input -->
        <div class="lg:col-span-1 space-y-6">
            <div id="imageContextCard" class="bg-gray-800 p-6 rounded-2xl shadow-2xl shadow-gray-950/70 border border-gray-700 transition duration-300 ease-in-out hover:border-indigo-600 hover:shadow-indigo-900/20">
                <h2 class="text-xl font-semibold mb-4 text-indigo-400 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    Destination Image
                </h2>
                
                <input type="file" id="imageUpload" accept="image/*" class="w-full text-sm text-gray-300
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-indigo-600 file:text-white
                    hover:file:bg-indigo-500 transition duration-150
                "/>
                
                <div id="previewContainer" class="mt-4 p-3 bg-gray-700 border-2 border-dashed border-gray-600 rounded-lg h-48 flex items-center justify-center upload-pulse">
                    <img id="imagePreview" src="https://placehold.co/400x200/1f2937/a5b4fc?text=Upload+Image+to+Start" alt="Image Preview" class="max-h-full max-w-full rounded-md object-contain transition duration-300" />
                </div>
            </div>

            <div class="flex space-x-4">
                <button id="resetButton" 
                    class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-2 rounded-xl shadow-lg shadow-gray-950/50 disabled:opacity-50 transition duration-150 ease-in-out transform hover:scale-[1.01]"
                    disabled>
                    <span class="flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        Reset Chat & Image
                    </span>
                </button>
            </div>
        </div>

        <!-- Right Panel: Chat Interface -->
        <div class="lg:col-span-2 bg-gray-800 rounded-2xl shadow-2xl shadow-gray-950/70 border border-gray-700 flex flex-col h-[600px] transition duration-300 ease-in-out">
            <h2 class="text-2xl font-bold p-4 text-indigo-400 border-b border-gray-700 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z"></path></svg>
                Conversation History
            </h2>
            
            <!-- Chat Messages Container -->
            <div id="chatMessages" class="flex-grow p-4 space-y-4 overflow-y-auto chat-container">
                <!-- Initial Welcome Message -->
                <div class="flex justify-start">
                    <div class="bg-ai-bubble max-w-2/3 p-3 rounded-xl rounded-tl-none shadow text-gray-200 prose-output message-fade-in">
                        <p>Hello there! I'm VisionAI. Upload an image of your desired destination to start planning your perfect trip. Once I see the image, we can start chatting!</p>
                    </div>
                </div>
            </div>

            <!-- Chat Input Area -->
            <div class="p-4 border-t border-gray-700">
                <div class="flex space-x-3">
                    <input type="text" id="chatInput" placeholder="Ask about history, food, or itinerary..." 
                        class="flex-grow p-3 border border-gray-600 rounded-lg bg-gray-700 text-gray-200 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out disabled:opacity-70 disabled:cursor-not-allowed"
                        disabled>
                    <button id="sendMessageButton" 
                        class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-indigo-900/50 disabled:opacity-50 flex items-center justify-center transition duration-150 ease-in-out transform hover:scale-[1.01]"
                        disabled>
                        Send
                        <div id="loadingIndicator" class="loading-animation hidden ml-3"></div>
                    </button>
                </div>
                <p id="errorMessage" class="text-red-400 text-sm mt-2 hidden"></p>
            </div>
        </div>

    </main>

    <footer class="p-4 bg-gray-900/90 backdrop-blur-sm text-center text-sm text-gray-500 mt-8 shadow-inner shadow-gray-950/50">
        Made with ‚ù§Ô∏è by Jatin & Diksharth | Powered by Gemini API
    </footer>

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>

    <script type="module">
        // Global variables provided by the environment (used for compatibility, not necessary for this client-side app)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- API Configuration ---
        // NOTE: The API_KEY is a placeholder and will be securely provided by the execution environment.
        const API_KEY = "AIzaSyAKaQYvWyo7ckZZg_FcM2WOlhORRFo2iFM"; 
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
        // -------------------------

        // DOM Elements
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const previewContainer = document.getElementById('previewContainer');
        const chatInput = document.getElementById('chatInput');
        const sendMessageButton = document.getElementById('sendMessageButton');
        const resetButton = document.getElementById('resetButton');
        const chatMessages = document.getElementById('chatMessages');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessageElement = document.getElementById('errorMessage');

        // State
        let base64Image = null; // Stores the current image context
        let chatHistory = []; // Stores the ongoing conversation

        // --- Utility Functions ---

        /**
         * Converts a File object to a Base64 string.
         */
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const dataUrl = reader.result;
                    const mimeTypeMatch = dataUrl.match(/^data:(.+?);base64,/);
                    const mimeType = mimeTypeMatch ? mimeTypeMatch[1] : file.type;
                    const base64Data = dataUrl.split(',')[1];
                    
                    if (base64Data) {
                        resolve({ data: base64Data, mimeType: mimeType });
                    } else {
                        reject(new Error("Could not extract base64 data."));
                    }
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        };

        /**
         * Simple exponential backoff retry mechanism for API calls.
         */
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        const errorBody = await response.text();
                        try {
                            const errorJson = JSON.parse(errorBody);
                            throw new Error(`API Error: ${response.status} - ${errorJson.error.message || 'Unknown API Error'}`);
                        } catch {
                            throw new Error(`API Error: ${response.status} - ${errorBody.substring(0, 100)}...`);
                        }
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * Adds a message bubble to the chat interface.
         * @param {string} text The content of the message.
         * @param {string} role 'user' or 'model'.
         * @returns {HTMLElement} The created message element.
         */
        function addMessage(text, role) {
            const isUser = role === 'user';
            const messageWrapper = document.createElement('div');
            // Add the fade-in class to the wrapper
            messageWrapper.className = `flex ${isUser ? 'justify-end' : 'justify-start'} message-fade-in`;

            const bubble = document.createElement('div');
            bubble.className = `max-w-3/4 p-3 rounded-xl shadow text-gray-200 prose-output break-words ${isUser ? 'bg-user-bubble rounded-tr-none' : 'bg-ai-bubble rounded-tl-none'}`;
            
            // Parse markdown and sanitize HTML before appending
            if (typeof marked !== 'undefined') {
                 bubble.innerHTML = marked.parse(text);
            } else {
                 bubble.textContent = text;
            }

            messageWrapper.appendChild(bubble);
            chatMessages.appendChild(messageWrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll
            return bubble;
        }

        /**
         * Adds a message bubble (non-markdown, used for placeholders/loading).
         * @param {string} text The content of the message.
         * @param {string} role 'user' or 'model'.
         * @returns {HTMLElement} The created message element.
         */
        function addPlaceholderMessage(text, role) {
            const isUser = role === 'user';
            const messageWrapper = document.createElement('div');
            // Add the fade-in class to the wrapper
            messageWrapper.className = `flex ${isUser ? 'justify-end' : 'justify-start'} message-fade-in`;

            const bubble = document.createElement('div');
            // Note: Does not apply prose-output classes for placeholder, only raw text content
            bubble.className = `max-w-3/4 p-3 rounded-xl shadow text-gray-200 break-words ${isUser ? 'bg-user-bubble rounded-tr-none' : 'bg-ai-bubble rounded-tl-none'}`;
            
            bubble.textContent = text;

            messageWrapper.appendChild(bubble);
            chatMessages.appendChild(messageWrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll
            return bubble;
        }

        /**
         * Handles the core interaction with the Gemini API.
         */
        async function sendChatMessage(prompt, isInitialPrompt = false) {
            errorMessageElement.classList.add('hidden');
            
            // If not the initial hidden prompt, add user message to UI and history
            if (!isInitialPrompt) {
                addMessage(prompt, 'user');
                chatHistory.push({ role: 'user', parts: [{ text: prompt }] });
            }
            
            // UI State: Loading
            chatInput.disabled = true;
            sendMessageButton.disabled = true;
            loadingIndicator.classList.remove('hidden');

            // Create a placeholder bubble for the model's response
            const modelBubble = addPlaceholderMessage('Thinking...', 'model'); 
            
            try {
                // System instructions guide the model's persona and behavior
                const systemPrompt = `You are a concise, helpful, and highly visual AI Travel Chatbot. 
                The user has provided an image of their destination (if available). 
                Your primary goal is to help them plan a trip based on that context, always suggesting follow-up topics (history, food, itinerary).
                
                Initial response (after image upload) should start with the identified location, followed by options for history, food, or itinerary.
                
                When providing attractions or food, format them as Markdown links using Google search queries for quick lookups: [Name](https://www.google.com/search?q=query+here+in+url+encoded+format).
                
                Always keep your responses conversational and brief. Maintain context from previous turns.`;

                // The request parts start with the image (if present) and the conversation history
                const contents = [...chatHistory];
                
                // Add the image to the first message of the conversation only (which is the user's initial prompt)
                if (base64Image && isInitialPrompt) {
                    contents.push({
                        role: "user",
                        parts: [
                            { text: prompt },
                            { inlineData: { data: base64Image.data, mimeType: base64Image.mimeType } }
                        ]
                    });
                } else if (!isInitialPrompt) {
                    // For subsequent non-initial messages, add the user message
                    // (It's already in chatHistory, so we just use chatHistory in contents)
                }


                const payload = {
                    // If initial prompt, use the crafted contents array with image
                    contents: isInitialPrompt ? contents : chatHistory,
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    tools: [{ "google_search": {} }] // Enable search grounding
                };
                
                // For the initial prompt, we need to ensure the system instruction is correctly placed.
                // The `chatHistory` array will be empty initially, and we push the entire initial 
                // multi-part message (text + image) into the contents array for the request.
                
                const response = await fetchWithRetry(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (generatedText) {
                    // Remove the placeholder bubble
                    modelBubble.remove();
                    
                    // Update UI bubble with final parsed Markdown
                    addMessage(generatedText, 'model');
                    
                    // Add model response to history
                    chatHistory.push({ role: 'model', parts: [{ text: generatedText }] });
                } else {
                    modelBubble.textContent = 'Sorry, I couldn\'t generate a response. Please try again.';
                }

            } catch (error) {
                console.error("Chat generation error:", error);
                modelBubble.textContent = `An error occurred: ${error.message}.`;
                errorMessageElement.textContent = `Chat failed: ${error.message}`;
                errorMessageElement.classList.remove('hidden');

            } finally {
                // UI State: Ready
                chatInput.value = '';
                chatInput.disabled = false;
                sendMessageButton.disabled = false;
                loadingIndicator.classList.add('hidden');
                chatInput.focus();
            }
        }
        
        // Function to reset the application state
        function resetApp() {
            base64Image = null;
            chatHistory = [];
            
            imageUpload.value = ''; // Clear file input
            chatInput.disabled = true;
            sendMessageButton.disabled = true;
            resetButton.disabled = true;
            errorMessageElement.classList.add('hidden');

            // Reset image preview to placeholder
            imagePreview.src = "https://placehold.co/400x200/1f2937/a5b4fc?text=Upload+Image+to+Start"; 
            imagePreview.alt = "Upload Image to Start";
            
            // Add pulse animation back to attract attention
            previewContainer.classList.add('upload-pulse');

            // Clear and reset chat messages
            chatMessages.innerHTML = '';
            addMessage('Hello there! I\'m WanderAI. Upload an image of your desired destination to start planning your perfect trip. Once I see the image, we can start chatting!', 'model');
            chatInput.focus();
        }


        // --- Event Listeners ---

        imageUpload.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            
            if (file) {
                try {
                    // Reset chat immediately upon new image upload
                    chatMessages.innerHTML = '';
                    chatHistory = [];
                    addPlaceholderMessage('Processing image...', 'model');

                    const result = await fileToBase64(file);
                    base64Image = result;
                    imagePreview.src = `data:${result.mimeType};base64,${result.data}`;
                    imagePreview.alt = `Preview of ${file.name}`;
                    
                    // Remove pulse animation
                    previewContainer.classList.remove('upload-pulse');
                    
                    // Enable chat interface
                    chatInput.disabled = false;
                    sendMessageButton.disabled = false;
                    resetButton.disabled = false;

                    // Send an initial hidden prompt to kick off the conversation 
                    sendChatMessage("Start the travel guide by identifying the location and asking how I'd like to plan my trip.", true);

                } catch (error) {
                    console.error("Error reading file:", error);
                    errorMessageElement.textContent = 'Error processing image file.';
                    errorMessageElement.classList.remove('hidden');
                    resetApp();
                }
            } else {
                resetApp();
            }
        });

        // Send message handler
        const handleSendMessage = () => {
            const prompt = chatInput.value.trim();
            if (prompt && !sendMessageButton.disabled) {
                sendChatMessage(prompt);
            }
        };

        sendMessageButton.addEventListener('click', handleSendMessage);
        
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevents a newline in the input field
                handleSendMessage();
            }
        });

        resetButton.addEventListener('click', resetApp);
        
        // Initial state setup once marked.js is confirmed loaded
        window.onload = () => {
             // Configure marked to open links in new tabs
            if (typeof marked !== 'undefined') {
                marked.use({
                    renderer: {
                        link(href, title, text) {
                            return `<a href="${href}"${title ? ` title="${title}"` : ''} target="_blank" rel="noopener noreferrer">${text}</a>`;
                        }
                    }
                });
            }
            resetApp();
        };

    </script>
</body>
</html> 